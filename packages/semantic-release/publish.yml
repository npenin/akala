jobs:
  build:
    steps:
      - name: semantic-release
        outputAs: releases
        job: ./semantic-releases.yml
      - name: versions
        dispatch: get-version
        with:
          path: $($)
        outputAs: versions
        foreach: $(build.releases.build.bumps)
      - name: eliminate private packages
        dispatch: eliminate-private
        outputAs: publicPackages
        with:
          packages: $(build.releases.build.bumps)
      - name: tag
        foreach: $(build.publicPackages)
        foreach-strategy: wait-for-previous
        run:
          - git
          - tag
          - -a
          - $($.name)@$($.version)
          - -m
          - tagging $($.name)@$($.version)
      - name: push
        run: git push origin --tags
        with:
          shell: true
      - name: publish
        foreach: $(build.publicPackages)
        run: yarn workspace $($.name) npm publish
        with:
          shell: true
