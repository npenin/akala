parameters:
  - package
  - changelogPath
outputs:
  name: $(package.name)
  location: $(package.location)
  bump: $(build.recommendBump)
  workspaceDependencies: $(package.workspaceDependencies)
# on:
#   failure:
#     name: $(package.name)
#     location: $(package.location)
#     bump: failed
#     workspaceDependencies: $(package.workspaceDependencies)

jobs:
  build:
    steps:
      - name: tags
        run: node node_modules/git-semver-tags/cli.mjs --lerna --package $(package.name) | head -n1
        with:
          result: stdout
          shell: true
      - name: commits
        run:
          - git
          - log
          - $(build.tags)..HEAD
          - --date=iso
          - --
          - $(package.location)
        with:
          result: stdout
          format: string
      - name: untagged commits
        if: $(!build.commits)
        outputAs: commits
        run:
          - git
          - log
          - --date=iso
          - --
          - $(package.location)
      - name: parse commits
        dispatch: parse
        with:
          commits: $(build.commits)
      - name: analyze commits
        dispatch: analyze
        with:
          commits: $(build.parseCommits)
      - name: recommendBump
        dispatch: recommend-bump
        with:
          commits: $(build.analyzeCommits)
          rules:
            build: patch
            ci: patch
            docs: patch
            feat: minor
            fix: patch
            perf: minor
            refactor: minor
            test: patch
            deps: patch
            chore: patch
            major: major
      - name: changelog
        dispatch: changelog
        with:
          commits: $(build.analyzeCommits)
          file: $(changelogPath)
